from llama_index.llms.openai import OpenAI
import os
from agents.tools import ResearchTools
from typing import List, Dict, Any

class SimpleResearchAgent:
    """–ü—Ä–æ—Å—Ç–æ–π –∞–≥–µ–Ω—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –Ω–∞—É—á–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π"""
    
    def __init__(self):
        self.tools = ResearchTools()
        self.chat_history = []
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º OpenAI –∫–ª—é—á
        openai_key = os.getenv("OPENAI_API_KEY")
        if openai_key:
            self.llm = OpenAI(
                model="gpt-4-turbo-preview",
                temperature=0.1,
                api_key=openai_key
            )
            self.use_llm = True
        else:
            self.use_llm = False
            print("‚ùå OpenAI API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    def chat(self, message: str) -> str:
        """–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤"""
        
        try:
            # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            self.chat_history.append({"role": "user", "content": message})
            
            # –ò—â–µ–º –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
            search_result = self.tools.search_research(message, detail_level="detailed")
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å LLM, —É–ª—É—á—à–∞–µ–º –æ—Ç–≤–µ—Ç
            if self.use_llm and "‚ùå" not in search_result and "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º" not in search_result:
                
                enhanced_prompt = f"""
–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–±—ä—è—Å–Ω–∏—Ç—å —Å–ª–æ–∂–Ω—É—é –Ω–∞—É—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–æ—Å—Ç—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º, —Å–æ—Ö—Ä–∞–Ω—è—è –≤—Å–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏.

–ò–°–•–û–î–ù–´–ô –ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: {message}

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –ò–ó –ù–ê–£–ß–ù–´–• –°–¢–ê–¢–ï–ô:
{search_result}

–ó–ê–î–ê–ß–ê:
1. –û–±—ä—è—Å–Ω–∏ –∫–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º
2. –°–æ—Ö—Ä–∞–Ω–∏ –≤—Å–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏, —Ñ–æ—Ä–º—É–ª—ã, –º–µ—Ç–æ–¥—ã
3. –ü–æ–∫–∞–∂–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
4. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ª–æ–≥–∏—á–Ω–æ
5. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–Ω—è—Ç–∏–π

–û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ. –ù–µ —Ç–µ—Ä—è–π –Ω–∞—É—á–Ω—É—é —Ç–æ—á–Ω–æ—Å—Ç—å, –Ω–æ –¥–µ–ª–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ–Ω—è—Ç–Ω–æ–π –¥–ª—è –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.
"""
                
                try:
                    enhanced_response = self.llm.complete(enhanced_prompt)
                    final_response = str(enhanced_response)
                except Exception as e:
                    final_response = f"üìö {search_result}\n\n‚ö†Ô∏è –£–ª—É—á—à–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ: {str(e)}"
            else:
                final_response = search_result
            
            # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            self.chat_history.append({"role": "assistant", "content": final_response})
            
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
            if len(self.chat_history) > 20:
                self.chat_history = self.chat_history[-20:]
            
            return final_response
            
        except Exception as e:
            error_message = f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}"
            self.chat_history.append({"role": "assistant", "content": error_message})
            return error_message
    
    def get_chat_history(self) -> List[Dict[str, str]]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"""
        return self.chat_history
    
    def clear_history(self):
        """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞"""
        self.chat_history = []
        
    def get_suggestions(self) -> List[str]:
        """–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Ç–µ–º –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è"""
        return [
            "–°—Ç–æ—Ö–∞—Å—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–∏–∫–æ–≤–æ–π —Ü–µ–Ω–æ–≤–æ–π –º–æ–¥–µ–ª–∏",
            "–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –≤ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä—ã–Ω–∫–æ–≤",
            "–ê–ª–≥–æ—Ä–∏—Ç–º—ã –≤—ã—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ –∏ –º–∏–∫—Ä–æ—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—ã–Ω–∫–∞",
            "Behavioral finance –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ —Ä—ã–Ω–∫–∞",
            "Risk management –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Ä–∏—Å–∫–∞–º–∏",
            "–ü–æ—Ä—Ç—Ñ–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö",
            "–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ —Ä—ã–Ω–∫–∏ –∏ –∏—Ö –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–¥–µ–ª–∏",
            "–≠–∫–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ –≤ —Ñ–∏–Ω–∞–Ω—Å–∞—Ö"
        ]
